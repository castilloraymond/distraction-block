# Scheduled Distraction Block Feature

**Date**: 2026-01-20
**Task**: Add scheduled blocking capability to site lists (e.g., 6-11AM weekdays)

## Overview

Allow users to configure schedules on site lists so that sites are automatically blocked during specific time windows on specific days, without needing to manually start a timer.

## Implementation Plan

### Phase 1: Storage Schema Extension

- [x] **1.1** Extend site list schema in storage to include schedule configuration:
  ```javascript
  schedule: {
    enabled: false,
    days: [],           // ["mon", "tue", "wed", "thu", "fri", "sat", "sun"]
    startTime: "06:00", // HH:MM format (24-hour)
    endTime: "11:00"
  }
  ```

### Phase 2: Schedule Evaluation Logic (background.js)

- [x] **2.1** Add `isScheduleActive(schedule)` function to check if current time falls within a schedule
- [x] **2.2** Add `getActiveScheduledLists()` function to return all site lists with currently active schedules
- [x] **2.3** Modify `generateRules()` to include sites from active scheduled lists (separate from timer rules)
- [x] **2.4** Add periodic alarm `scheduleCheck` that fires every minute to re-evaluate schedules
- [x] **2.5** Handle schedule transitions (entering/exiting scheduled block periods) by regenerating rules

### Phase 3: Popup UI (popup.js + popup.html)

- [x] **3.1** Add schedule configuration UI section to the site list modal/form
- [x] **3.2** Add day-of-week checkboxes (Mon-Sun)
- [x] **3.3** Add time picker inputs for start and end times
- [x] **3.4** Add "Enable Schedule" toggle
- [x] **3.5** Save schedule data when saving site list
- [x] **3.6** Display schedule status indicator on site lists

### Phase 4: Integration & Edge Cases

- [x] **4.1** Ensure scheduled blocks work independently of timer (coexist)
- [x] **4.2** Handle rule ID ranges: use 100000-149999 for scheduled list rules
- [x] **4.3** Update blocked.html to show schedule info when blocked by schedule
- [x] **4.4** Initialize schedule checker alarm on extension startup

## Technical Details

### Rule Priority System
- Priority 2: Whitelist/allow rules (highest)
- Priority 1: Timer blocks, scheduled blocks, individual blocks

### Rule ID Ranges
- 1000-49999: Individual blocked sites
- 50000-99999: Timer-based blocking
- 100000-149999: Schedule-based blocking (NEW)

### Storage Location
- Schedule config stored within each site list object in `siteLists` array

## Files Modified

1. **background.js** - Schedule logic, rule generation, alarm handling
2. **popup.js** - Schedule UI logic, save/load schedules
3. **popup.html** - Schedule form inputs in site list modal
4. **popup.css** - Schedule-related styles
5. **blocked.html** - Display schedule info when blocked by schedule

## Review

### Summary of Changes

**background.js** (website-blocker/src/background/background.js):
- Added `isScheduleActive(schedule)` function to evaluate if current time/day falls within a schedule
- Added `getActiveScheduledLists()` function to get all lists with active schedules
- Modified `generateRules()` to include rules for scheduled lists (ID range 100000-149999)
- Added `checkScheduleTransitions()` to detect schedule state changes and update rules
- Added `setupScheduleAlarm()` to create a 1-minute periodic alarm
- Added `scheduleCheck` alarm handler in the alarm listener
- Added `GET_ACTIVE_SCHEDULED_LISTS` message handler
- Updated `onInstalled` and `onStartup` to initialize schedule checking

**popup.html** (website-blocker/src/popup/popup.html):
- Added "Edit Schedule Modal" with enable toggle, day checkboxes, and time pickers

**popup.css** (website-blocker/src/popup/popup.css):
- Added styles for schedule days, time inputs, badges, and buttons

**popup.js** (website-blocker/src/popup/popup.js):
- Added schedule modal elements and event listeners
- Added `openScheduleModal()` function to populate and show the schedule modal
- Updated `renderSiteLists()` to show schedule badges and add schedule buttons

**blocked.html** (website-blocker/src/pages/blocked.html):
- Added schedule info section to display when blocked by schedule
- Updated script to check for active scheduled lists if no timer is active

### How It Works
1. User creates a site list and clicks "Add Schedule" or "Edit Schedule"
2. Schedule modal allows setting days (Mon-Sun) and time range (start/end)
3. Every minute, the `scheduleCheck` alarm evaluates if any schedules have become active/inactive
4. If schedule state changes, rules are regenerated to add/remove blocking
5. Blocked page shows schedule info when blocked by a scheduled list

### Edge Cases Handled
- Schedules work independently of the manual focus timer
- If a list is both timer-blocked and schedule-blocked, timer takes precedence
- Schedule transitions are detected and rules are updated automatically
- Browser restart reinitializes schedule checking
