# Fix Timer Blocking Bug

## Problem
Sites remain blocked even after the timer has completed.

## Root Cause Analysis
After analyzing `background.js`, I found the following issues:

### Bug 1: Incomplete alarm clearing in `checkAndCleanExpiredTimer()`
At line 316, only `focusTimerExpiration` alarm is cleared, but `timerExpirationCheck` is not cleared. This should clear both alarms like `stopTimer()` does.

### Bug 2: Error handling in alarm listener doesn't update rules
In the alarm listener error handler (lines 1059-1066), when an error occurs, the timer is removed from storage and alarms are cleared, but **the blocking rules are not updated**. This leaves the timer-based blocking rules in place even though the timer was cleared.

### Bug 3: Order of operations in `checkAndCleanExpiredTimer()`
The timer is removed from storage (line 319) before the rules are updated (lines 322-324). If rule update fails, the timer is gone but blocking rules remain, causing sites to stay blocked.

## Fix Plan

- [x] Fix 1: Clear both alarms in `checkAndCleanExpiredTimer()` (line 316)
- [x] Fix 2: Add rule update to the alarm listener error handler (after line 1063)
- [x] Fix 3: Improve error handling to ensure rules are updated even on partial failure

## Files Modified
- `website-blocker/src/background/background.js`

## Review

### Changes Made

1. **`checkAndCleanExpiredTimer()` function (lines 312-347)**:
   - Now clears both `focusTimerExpiration` AND `timerExpirationCheck` alarms
   - Added inner try/catch with retry logic for rule updates
   - If rule update fails, it retries once to ensure blocking rules are removed

2. **Alarm listener error handler (lines 1072-1090)**:
   - Added rule update logic after clearing the timer in the error handler
   - Added icon update to clear the timer badge
   - Ensures that even if `checkAndCleanExpiredTimer()` throws, the rules are still updated

### Root Cause
The bug occurred because:
1. Only one alarm was being cleared in `checkAndCleanExpiredTimer()`
2. If rule update failed, the timer was removed but blocking rules remained in place
3. The error handler in the alarm listener cleared the timer but didn't update the declarativeNetRequest rules

### How the Fix Works
When the timer expires:
1. Both alarms are cleared immediately
2. Timer is removed from storage
3. Rules are regenerated (now sees no active timer â†’ generates only individual site rules)
4. Rules are updated with retry logic to ensure reliability
5. Even if an error occurs, the fallback error handler will also attempt to update rules
